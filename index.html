<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoCall í´ë”/ì´ë ¥</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#0b0f17; color:#e8eefc;}
    header{padding:14px 16px; position:sticky; top:0; background:#0b0f17; border-bottom:1px solid #1c2540;}
    .wrap{display:grid; grid-template-columns: 260px 1fr; gap:12px; padding:12px;}
    .card{background:#121a2d; border:1px solid #1c2540; border-radius:14px; padding:12px;}
    .row{display:flex; gap:8px; align-items:center;}
    .col{display:flex; flex-direction:column; gap:8px;}
    button{background:#1f6feb; border:none; color:white; padding:10px 12px; border-radius:12px; cursor:pointer;}
    button.secondary{background:#22304f;}
    button.danger{background:#b42318;}
    input, select, textarea{background:#0b1326; color:#e8eefc; border:1px solid #1c2540; border-radius:10px; padding:10px; width:100%;}
    textarea{min-height:64px;}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:8px;}
    .item{padding:10px; border:1px solid #1c2540; border-radius:12px; background:#0b1326;}
    .muted{color:#9fb2d8; font-size:12px;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #1c2540; font-size:12px; color:#bcd0ff;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px;}
    @media(max-width:900px){ .wrap{grid-template-columns: 1fr;} }
    a.tel{color:#fff; text-decoration:none; display:inline-block; padding:10px 12px; border-radius:12px; background:#2ea043; text-align:center;}
  </style>
</head>
<body>
<header class="row" style="justify-content:space-between;">
  <div class="row" style="gap:10px;">
    <strong>ğŸ“ AutoCall</strong>
    <span class="pill" id="syncState">ë¡œë”©ì¤‘â€¦</span>
  </div>
  <div class="row">
    <button class="secondary" id="btnSync">ë™ê¸°í™”</button>
    <button class="secondary" id="btnExport">ë‚´ë³´ë‚´ê¸°</button>
    <input type="file" id="importFile" style="display:none" />
    <button class="secondary" id="btnImport">ê°€ì ¸ì˜¤ê¸°</button>
  </div>
</header>

<div class="wrap">
  <aside class="card">
    <div class="row" style="justify-content:space-between;">
      <strong>í´ë”</strong>
      <button id="btnAddFolder">+ í´ë”</button>
    </div>
    <div class="list" id="folderList"></div>
  </aside>

  <main class="col">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="col" style="gap:2px;">
          <strong id="currentFolderTitle">ì—°ë½ì²˜</strong>
          <span class="muted" id="currentFolderHint">í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
        </div>
        <button id="btnAddContact">+ ì—°ë½ì²˜</button>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <input id="search" placeholder="ê²€ìƒ‰: ì´ë¦„/ë²ˆí˜¸/ë©”ëª¨" />
        <select id="sort">
          <option value="recent">ìµœê·¼ í†µí™”ìˆœ</option>
          <option value="name">ì´ë¦„ìˆœ</option>
          <option value="count">í†µí™”íšŸìˆ˜ìˆœ</option>
        </select>
      </div>

      <div class="list" id="contactList"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>ì½œ ì´ë ¥(ìµœê·¼ 30ê°œ)</strong>
        <button class="secondary" id="btnRefreshCalls">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="list" id="callList"></div>
      <div class="muted" style="margin-top:8px;">
        * ì „í™” ì¢…ë£Œ ìë™ ê°ì§€ëŠ” ì–´ë µìŠµë‹ˆë‹¤. í†µí™” í›„ ê²°ê³¼(ì™„ë£Œ/ë¶€ì¬/ì½œë°±)ë§Œ ì €ì¥í•´ë„ ìš´ì˜ì´ í¸í•´ìš”.
      </div>
    </section>
  </main>
</div>

<script>
  // ======= ì„¤ì • =======
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxOSatFN8wImhTBgOBN7h2an9DsciXYoLB4y-sRFr7NRS3xyiTNCwzCTWhZWpQCIG07/exec"; // ë°°í¬ í›„ URLë¡œ êµì²´
  const TOKEN = "AUTO_CALL_JH_2026_02_02_x9Pq7LkD3"; // Apps Scriptì˜ API_TOKENê³¼ ë™ì¼í•´ì•¼ í•¨

  // ======= ìƒíƒœ =======
  let db = { folders: [], contacts: [], calls: [] };
  let currentFolderId = null;

  const $ = (id) => document.getElementById(id);

  function setSyncBadge(text, ok=true){
    const el = $("syncState");
    el.textContent = text;
    el.style.borderColor = ok ? "#1c2540" : "#b42318";
    el.style.color = ok ? "#bcd0ff" : "#ffb4aa";
  }

  // ======= API =======
  async function apiGet(action){
    const url = new URL(WEBAPP_URL);
    url.searchParams.set("action", action);
    url.searchParams.set("token", TOKEN);
    const res = await fetch(url.toString());
    return res.json();
  }
  async function apiPost(payload){
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: TOKEN, ...payload })
    });
    return res.json();
  }

  // ======= ë™ê¸°í™” =======
  async function sync(){
    setSyncBadge("ë™ê¸°í™” ì¤‘â€¦");
    const r = await apiGet("exportAll");
    if(!r.ok){ setSyncBadge("ë™ê¸°í™” ì‹¤íŒ¨", false); alert(r.error); return; }
    db = { folders: r.folders || [], contacts: r.contacts || [], calls: r.calls || [] };
    localStorage.setItem("autocall_db_cache", JSON.stringify(db));
    renderAll();
    setSyncBadge("ë™ê¸°í™” ì™„ë£Œ âœ…");
  }

  function loadCache(){
    const raw = localStorage.getItem("autocall_db_cache");
    if(raw){
      try { db = JSON.parse(raw); setSyncBadge("ìºì‹œ ë¡œë“œ(ì˜¤í”„ë¼ì¸)"); }
      catch(e){}
    }
  }

  // ======= ë Œë” =======
  function renderFolders(){
    const list = $("folderList");
    list.innerHTML = "";
    const items = db.folders.slice().sort((a,b)=> String(a.name).localeCompare(String(b.name)));
    for(const f of items){
      const div = document.createElement("div");
      div.className = "item";
      div.style.cursor = "pointer";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <strong>${escapeHtml(f.name || "(ì´ë¦„ì—†ìŒ)")}</strong>
            <div class="muted">${escapeHtml(f.id)}</div>
          </div>
          <span class="pill">${currentFolderId===f.id ? "ì„ íƒë¨" : "ì—´ê¸°"}</span>
        </div>
      `;
      div.onclick = () => { currentFolderId = f.id; renderAll(); };
      list.appendChild(div);
    }
  }

  function getCurrentFolder(){
    return db.folders.find(x => String(x.id) === String(currentFolderId)) || null;
  }

  function filteredContacts(){
    const q = ($("search").value || "").trim().toLowerCase();
    let arr = db.contacts.slice();
    if(currentFolderId) arr = arr.filter(c => String(c.folderId) === String(currentFolderId));
    if(q){
      arr = arr.filter(c =>
        (c.name||"").toLowerCase().includes(q) ||
        (c.phone||"").toLowerCase().includes(q) ||
        (c.memo||"").toLowerCase().includes(q)
      );
    }
    const sort = $("sort").value;
    if(sort === "recent"){
      arr.sort((a,b)=> String(b.lastCalledAt||"").localeCompare(String(a.lastCalledAt||"")));
    } else if(sort === "name"){
      arr.sort((a,b)=> String(a.name||"").localeCompare(String(b.name||"")));
    } else if(sort === "count"){
      arr.sort((a,b)=> Number(b.callCount||0) - Number(a.callCount||0));
    }
    return arr;
  }

  function renderContacts(){
    const folder = getCurrentFolder();
    $("currentFolderTitle").textContent = folder ? `ì—°ë½ì²˜ Â· ${folder.name}` : "ì—°ë½ì²˜";
    $("currentFolderHint").textContent = folder ? "ì „í™” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ë ¥ì´ ì €ì¥ë©ë‹ˆë‹¤." : "ì™¼ìª½ì—ì„œ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
    const list = $("contactList");
    list.innerHTML = "";

    const arr = filteredContacts();
    for(const c of arr){
      const div = document.createElement("div");
      div.className = "item";
      const last = c.lastCalledAt ? new Date(c.lastCalledAt).toLocaleString() : "ì—†ìŒ";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between; gap:10px;">
          <div style="flex:1;">
            <div class="row" style="justify-content:space-between;">
              <strong>${escapeHtml(c.name||"(ì´ë¦„ì—†ìŒ)")}</strong>
              <span class="pill">í†µí™” ${Number(c.callCount||0)}íšŒ</span>
            </div>
            <div class="muted">ğŸ“± ${escapeHtml(c.phone||"")} Â· ë§ˆì§€ë§‰: ${escapeHtml(last)}</div>
            ${c.memo ? `<div class="muted">ğŸ“ ${escapeHtml(c.memo)}</div>` : ``}
          </div>
          <div class="col" style="min-width:140px;">
            <a class="tel" href="tel:${encodeURIComponent(c.phone||"")}" data-id="${c.id}">ì „í™”í•˜ê¸°</a>
            <button class="secondary" data-edit="${c.id}">ìˆ˜ì •</button>
          </div>
        </div>
      `;

      // ì „í™” í´ë¦­ ì‹œ ì½œë¡œê·¸ ë‚¨ê¸°ê¸°
      div.querySelector("a.tel").addEventListener("click", async (ev) => {
        if(!(c.phone||"").trim()) {
          ev.preventDefault();
          alert("ì „í™”ë²ˆí˜¸ê°€ ë¹„ì–´ ìˆì–´ìš”.");
          return;
        }
        const folder = getCurrentFolder();
        await apiPost({
          action: "logCall",
          contactId: c.id,
          folderId: c.folderId,
          folderName: folder ? folder.name : (c.folderName||""),
          name: c.name || "",
          phone: c.phone || "",
          result: "pending",
          note: ""
        });
        setSyncBadge("í†µí™” ê¸°ë¡ë¨(ìºì‹œ)", true);
        setTimeout(sync, 800);
      });

      div.querySelector("button[data-edit]").onclick = () => editContact(c.id);

      list.appendChild(div);
    }

    if(arr.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.padding = "10px";
      empty.textContent = "ì—°ë½ì²˜ê°€ ì—†ì–´ìš”. + ì—°ë½ì²˜ë¡œ ì¶”ê°€í•´ë³´ì„¸ìš”.";
      list.appendChild(empty);
    }
  }

  function renderCalls(){
    const list = $("callList");
    list.innerHTML = "";
    const calls = db.calls.slice()
      .sort((a,b)=> String(b.calledAt||"").localeCompare(String(a.calledAt||"")))
      .slice(0,30);

    for(const call of calls){
      const dt = call.calledAt ? new Date(call.calledAt).toLocaleString() : "";
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <strong>${escapeHtml(call.name||"")}</strong>
            <div class="muted">${escapeHtml(call.folderName||"")} Â· ${escapeHtml(call.phone||"")} Â· ${escapeHtml(dt)}</div>
            ${call.note ? `<div class="muted">ğŸ“ ${escapeHtml(call.note)}</div>` : ``}
          </div>
          <div class="col" style="min-width:210px;">
            <select data-result="${call.id}">
              <option value="pending" ${call.result==="pending"?"selected":""}>ëŒ€ê¸°</option>
              <option value="done" ${call.result==="done"?"selected":""}>ì™„ë£Œ</option>
              <option value="no_answer" ${call.result==="no_answer"?"selected":""}>ë¶€ì¬</option>
              <option value="callback" ${call.result==="callback"?"selected":""}>ì½œë°±</option>
            </select>
            <button class="secondary" data-save="${call.id}">ì €ì¥</button>
          </div>
        </div>
      `;
      div.querySelector("button[data-save]").onclick = async () => {
        const sel = div.querySelector(`select[data-result="${call.id}"]`);
        const result = sel.value;
        const note = prompt("ë©”ëª¨(ì„ íƒ):", call.note ?? "") ?? "";
        const r = await apiPost({ action:"updateCallResult", callId: call.id, result, note });
        if(!r.ok){ alert(r.error || "ì €ì¥ ì‹¤íŒ¨"); return; }
        setTimeout(sync, 300);
      };
      list.appendChild(div);
    }

    if(calls.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.padding = "10px";
      empty.textContent = "ì½œ ì´ë ¥ì´ ì•„ì§ ì—†ì–´ìš”. ì „í™”í•˜ê¸°ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.";
      list.appendChild(empty);
    }
  }

  function renderAll(){
    renderFolders();
    renderContacts();
    renderCalls();
  }

  // ======= ì•¡ì…˜: í´ë”/ì—°ë½ì²˜ CRUD =======
  async function addFolder(){
    const name = prompt("í´ë” ì´ë¦„(ì˜ˆ: ì„œìš¸ì§€ì—­):", "")?.trim();
    if(!name) return;
    const r = await apiPost({ action:"createFolder", name });
    if(!r.ok){ alert(r.error); return; }
    await sync();
    currentFolderId = r.id;
    renderAll();
  }

  async function addContact(){
    const folder = getCurrentFolder();
    if(!folder){ alert("ë¨¼ì € í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
    const name = prompt("ì´ë¦„:", "")?.trim() || "";
    const phone = prompt("ì „í™”ë²ˆí˜¸(ìˆ«ì/í•˜ì´í”ˆ ê°€ëŠ¥):", "")?.trim() || "";
    const memo = prompt("ë©”ëª¨(ì„ íƒ):", "")?.trim() || "";
    const r = await apiPost({
      action:"createContact",
      folderId: folder.id,
      folderName: folder.name,
      name, phone, memo
    });
    if(!r.ok){ alert(r.error); return; }
    await sync();
  }

  function editContact(contactId){
    const c = db.contacts.find(x => String(x.id) === String(contactId));
    if(!c) return;
    const name = prompt("ì´ë¦„:", c.name||"") ?? c.name||"";
    const phone = prompt("ì „í™”ë²ˆí˜¸:", c.phone||"") ?? c.phone||"";
    const memo = prompt("ë©”ëª¨:", c.memo||"") ?? c.memo||"";
    const folder = getCurrentFolder();
    apiPost({
      action:"updateContact",
      id: c.id,
      folderId: c.folderId,
      folderName: folder ? folder.name : (c.folderName||""),
      name, phone, memo
    }).then(()=> setTimeout(sync, 300));
  }

  // ======= ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° =======
  function exportJson(){
    const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "autocall_backup.json";
    a.click();
  }
  function importJson(file){
    const reader = new FileReader();
    reader.onload = async () => {
      try{
        const imported = JSON.parse(reader.result);
        db = imported;
        localStorage.setItem("autocall_db_cache", JSON.stringify(db));
        renderAll();
        alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ(ë¡œì»¬ ìºì‹œ). êµ¬ê¸€ ì‹œíŠ¸ì— ëŒ€ëŸ‰ ë°˜ì˜ì€ ë³„ë„ 'ì¼ê´„ ì—…ë¡œë“œ' ê¸°ëŠ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      }catch(e){
        alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: " + e);
      }
    };
    reader.readAsText(file);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ======= ì´ë²¤íŠ¸ =======
  $("btnAddFolder").onclick = addFolder;
  $("btnAddContact").onclick = addContact;
  $("btnSync").onclick = sync;
  $("btnExport").onclick = exportJson;
  $("btnImport").onclick = ()=> $("importFile").click();
  $("importFile").addEventListener("change", (e)=>{
    if(e.target.files && e.target.files[0]) importJson(e.target.files[0]);
  });
  $("btnRefreshCalls").onclick = sync;
  $("search").addEventListener("input", renderContacts);
  $("sort").addEventListener("change", renderContacts);

  // ì‹œì‘
  loadCache();
  renderAll();

  // ì²« ì—°ê²° ì²´í¬
  if(WEBAPP_URL.startsWith("PASTE_")) {
    setSyncBadge("WEBAPP_URL ë„£ì–´ì£¼ì„¸ìš”", false);
  } else {
    apiGet("ping").then(r=>{
      if(r.ok) sync();
      else setSyncBadge("API ì—°ê²° ì‹¤íŒ¨", false);
    }).catch(()=> setSyncBadge("API ì—°ê²° ì‹¤íŒ¨", false));
  }
</script>
</body>
</html>
